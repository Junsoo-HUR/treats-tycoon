<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TREATS 타이쿤 - 액상 회사를 경영하세요!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #111827; }
        .slider-thumb::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #4f46e5; cursor: pointer; border-radius: 50%; }
        .slider-thumb::-moz-range-thumb { width: 20px; height: 20px; background: #4f46e5; cursor: pointer; border-radius: 50%; }
        .flavor-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:disabled { background-color: #374151; cursor: not-allowed; opacity: 0.6; }
        .btn:not(:disabled):hover { filter: brightness(1.2); }
    </style>
</head>
<body class="text-white">

    <!-- 로그인 컨테이너 -->
    <div id="login-container" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md bg-gray-800 p-8 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-center text-indigo-400 mb-2">TREATS 타이쿤</h1>
            <p class="text-center text-gray-400 mb-6">로그인하여 회사를 경영하세요</p>
            <div class="space-y-4">
                <input type="email" id="email-input" placeholder="이메일" class="w-full bg-gray-700 text-white p-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="password-input" placeholder="비밀번호" class="w-full bg-gray-700 text-white p-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div id="auth-error" class="text-red-400 text-sm mt-4 h-5 text-center"></div>
            <div class="grid grid-cols-2 gap-4 mt-4">
                <button id="login-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg btn">로그인</button>
                <button id="signup-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg btn">회원가입</button>
            </div>
            <div class="mt-4">
                 <button id="guest-login-btn" class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg btn">게스트로 플레이하기</button>
            </div>
        </div>
    </div>
    
    <!-- 메인 게임 컨테이너 -->
    <div id="game-container" class="container mx-auto p-4 md:p-6 max-w-7xl hidden">
        <header class="text-center mb-6 relative">
            <div id="user-info-container" class="absolute top-0 right-0 text-right">
                <p id="user-email" class="text-gray-300"></p>
                <button id="logout-btn" class="text-sm text-indigo-400 hover:underline">로그아웃</button>
            </div>
            <h1 class="text-4xl md:text-5xl font-bold text-indigo-400">TREATS 타이쿤 🏢</h1>
            <p class="text-gray-400 mt-2">최고의 액상을 만들고, 회사를 성장시켜 업계의 전설이 되세요!</p>
        </header>

        <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-6 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
            <div><h2 class="text-sm font-bold text-gray-400">💰 자본금</h2><p id="cash" class="text-2xl font-bold text-green-400">$1,000</p></div>
            <div><h2 class="text-sm font-bold text-gray-400">📈 총매출 (점수)</h2><p id="total-sales" class="text-2xl font-bold text-blue-400">$0</p></div>
            <div><h2 class="text-sm font-bold text-gray-400">🏭 회사 레벨</h2><p id="company-level" class="text-2xl font-bold text-purple-400">1</p></div>
            <div><h2 class="text-sm font-bold text-gray-400">⭐ 최고 평점 레시피</h2><p id="best-recipe-name" class="text-lg font-bold text-yellow-400">-</p></div>
        </div>

        <main class="grid lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">👨‍🔬 액상 제조기</h2>
                <div class="mb-2">
                    <h3 class="font-bold mb-2 text-sm">1. 향료 선택 (최대 3개)</h3>
                    <div id="flavor-options" class="grid flavor-grid gap-2 text-sm max-h-32 overflow-y-auto pr-2"></div>
                </div>
                <div class="mb-2">
                    <h3 class="font-bold mb-3 text-sm">2. 비율 조절</h3>
                    <div class="space-y-2">
                        <div><label for="vg-slider" class="flex justify-between text-xs"><span>VG</span><span id="vg-value" class="font-bold text-indigo-300">50%</span></label><input id="vg-slider" type="range" min="0" max="100" value="50" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb"></div>
                        <div><label for="flavor-strength-slider" class="flex justify-between text-xs"><span>향료 농도</span><span id="flavor-strength-value" class="font-bold text-indigo-300">10%</span></label><input id="flavor-strength-slider" type="range" min="1" max="30" value="10" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb"></div>
                        <div><label for="nicotine-slider" class="flex justify-between text-xs"><span>니코틴</span><span id="nicotine-value" class="font-bold text-indigo-300">3mg</span></label><input id="nicotine-slider" type="range" min="0" max="20" value="3" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb"></div>
                        <div><label for="cooling-slider" class="flex justify-between text-xs"><span>쿨링 강도</span><span id="cooling-value" class="font-bold text-indigo-300">0</span></label><input id="cooling-slider" type="range" min="0" max="10" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb"></div>
                    </div>
                </div>
                <div class="mb-2">
                    <h3 class="font-bold mb-2 text-sm">3. 이름 짓기</h3>
                    <input type="text" id="recipe-name-input" placeholder="액상 이름을 지어주세요..." class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mb-4">
                    <h3 class="font-bold mb-2 text-sm">4. 가격 책정 ($10 ~ $30)</h3>
                    <label for="price-slider" class="flex justify-between text-xs"><span>판매 가격</span><span id="price-value" class="font-bold text-green-400">$20</span></label>
                    <input id="price-slider" type="range" min="10" max="30" value="20" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb">
                </div>
                 <div class="bg-gray-900 p-3 rounded-lg mb-4">
                     <h3 class="font-bold mb-2 text-center text-md">🧪 레시피 요약</h3>
                     <div class="grid grid-cols-5 gap-1 text-center text-xs">
                        <div><p class="text-gray-400">VG</p><p id="summary-vg" class="font-semibold">50%</p></div>
                        <div><p class="text-gray-400">PG</p><p id="summary-pg" class="font-semibold">40%</p></div>
                        <div><p class="text-gray-400">향료</p><p id="summary-flavor" class="font-semibold">10%</p></div>
                        <div><p class="text-gray-400">니코틴</p><p id="summary-nicotine" class="font-semibold">3mg</p></div>
                        <div><p class="text-gray-400">쿨링</p><p id="summary-cooling" class="font-semibold">0</p></div>
                     </div>
                </div>
                <button id="create-batch-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg btn">제조 및 판매 (비용: $50)</button>
            </div>

            <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">📢 판매 결과 로그</h2>
                <div id="log" class="h-[46rem] overflow-y-auto space-y-3 pr-2">
                    <div class="text-gray-400">액상을 제조하면 여기에 판매 결과가 표시됩니다.</div>
                </div>
            </div>
            
            <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col">
                 <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">🏢 회사 관리</h2>
                 <div class="mb-4 bg-gray-900 p-4 rounded-lg text-center">
                     <h3 class="font-bold text-indigo-300">📈 시장 트렌드</h3>
                     <p id="market-trend" class="text-lg">분석 중...</p>
                 </div>
                 <h3 class="font-bold text-lg mb-3">🛠️ 회사 업그레이드</h3>
                 <div id="upgrades-container" class="space-y-3 mb-4"></div>
                 
                 <div class="flex-grow flex flex-col min-h-0">
                    <h3 class="font-bold text-lg mb-3 text-yellow-300">🏆 리더보드</h3>
                    <div id="leaderboard" class="bg-gray-900 p-4 rounded-lg flex-grow overflow-y-auto">
                        <div class="text-center text-gray-400">리더보드 로딩 중...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase 설정 ---
        const firebaseConfig = {
          apiKey: "AIzaSyCjDwX6xPw3SUee1v1uV82I5knKSC3LFkY",
          authDomain: "treats-ty.firebaseapp.com",
          projectId: "treats-ty",
          storageBucket: "treats-ty.firebasestorage.app",
          messagingSenderId: "237687562163",
          appId: "1:237687562163:web:07fa35e6fd8b28950735c6",
          measurementId: "G-R001G0DS6W"
        };

        let db, auth;
        try {
            if (!firebaseConfig.apiKey) {
                throw new Error("Firebase 설정이 비어있습니다.");
            }
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error(e.message);
            document.addEventListener('DOMContentLoaded', () => {
                const loginContainer = document.getElementById('login-container');
                if (loginContainer) {
                    document.getElementById('login-btn').disabled = true;
                    document.getElementById('signup-btn').disabled = true;
                    const authError = document.getElementById('auth-error');
                    if(authError) authError.textContent = "서버 연결 실패. 게스트로만 플레이 가능합니다.";
                }
            });
        }

        const dom = {};
        ['login-container', 'game-container', 'email-input', 'password-input', 'login-btn', 'signup-btn', 'guest-login-btn', 'logout-btn', 'auth-error', 'user-email', 'cash', 'total-sales', 'company-level', 'best-recipe-name', 'flavor-options', 'log', 'vg-slider', 'nicotine-slider', 'flavor-strength-slider', 'cooling-slider', 'price-slider', 'vg-value', 'nicotine-value', 'flavor-strength-value', 'cooling-value', 'price-value', 'summary-vg', 'summary-pg', 'summary-flavor', 'summary-nicotine', 'summary-cooling', 'recipe-name-input', 'create-batch-btn', 'market-trend', 'upgrades-container', 'leaderboard'].forEach(id => dom[id.replace(/-/g, '_')] = document.getElementById(id));
        
        const BATCH_COST = 50;
        const FLAVORS = [ { name: '딸기', category: '과일' }, { name: '바나나', category: '과일' }, { name: '블루베리', category: '과일' }, { name: '망고', category: '과일' }, { name: '레몬', category: '과일' }, { name: '라임', category: '과일' }, { name: '사과', category: '과일' }, { name: '복숭아', category: '과일' }, { name: '자두', category: '과일' }, { name: '파인애플', category: '과일' }, { name: '포도', category: '과일' }, { name: '자몽', category: '과일' }, { name: '수박', category: '과일' }, { name: '멜론', category: '과일' }, { name: '리치', category: '과일' }, { name: '체리', category: '과일' }, { name: '패션후르츠', category: '과일' }, { name: '바닐라', category: '디저트' }, { name: '커스타드', category: '디저트' }, { name: '치즈케이크', category: '디저트' }, { name: '초콜릿', category: '디저트' }, { name: '카라멜', category: '디저트' }, { name: '애플파이', category: '디저트' }, { name: '도넛', category: '디저트' }, { name: '브라우니', category: '디저트' }, { name: '쿠키앤크림', category: '디저트' }, { name: '슈크림', category: '디저트' }, { name: '피넛버터', category: '디저트' }, { name: '크림브륄레', category: '디저트' }, { name: '연초', category: '연초' }, { name: '시가', category: '연초' }, { name: '버지니아', category: '연초' }, { name: '터키쉬', category: '연초' }, { name: '멘솔', category: '멘솔' }, { name: '스피어민트', category: '멘솔' }, { name: '쿨민트', category: '멘솔' }, { name: '커피', category: '음료' }, { name: '콜라', category: '음료' }, { name: '에너지드링크', category: '음료' }, { name: '녹차', category: '음료' }, { name: '밀크티', category: '음료' }, { name: '모히토', category: '음료' }, { name: '꿀', category: '기타' }, { name: '시나몬', category: '기타' }, { name: '장미', category: '기타' }, { name: '팝콘', category: '기타' }, ];
        const COMBO_SCORES = {'과일-과일': 1.0, '과일-디저트': 0.95, '과일-멘솔': 0.9, '과일-음료': 0.8, '디저트-디저트': 0.8, '디저트-멘솔': 0.6, '디저트-연초': 0.9, '디저트-음료': 0.85, '연초-연초': 1.0, '연초-멘솔': 0.7, '연초-기타': 0.8, '멘솔-음료': 0.85, '기타-디저트': 0.9, '기타-과일': 0.7};
        
        let gameState = {};
        let currentUser = null;
        let unsubscribeLeaderboard = null;

        function getBaseGameState() {
            return {
                email: '', cash: 1000, totalSales: 0, companyLevel: 1, batchesMade: 0,
                bestRecipe: { name: '-', score: 0 },
                upgrades: {
                    lab: { level: 0, cost: 250, baseCost: 250, bonus: 0, bonusPerLevel: 0.01, maxLevel: 10, name: "🔬 연구실 확장" },
                    marketing: { level: 0, cost: 400, baseCost: 400, bonus: 0, bonusPerLevel: 0.05, maxLevel: 15, name: "📢 마케팅" },
                    flavor_rnd: { level: 0, cost: 1000, baseCost: 1000, bonus: 0, bonusPerLevel: 0.02, maxLevel: 5, name: "⚗️ 향료 R&D" }
                },
                marketTrend: { category: null, duration: 0, bonus: 1.5 }
            };
        }
        
        if (auth) {
            onAuthStateChanged(auth, async user => {
                if (user) {
                    currentUser = user;
                    dom.user_email.textContent = user.isAnonymous ? '게스트' : user.email;
                    dom.login_container.classList.add('hidden');
                    dom.game_container.classList.remove('hidden');
                    await loadGameData(user.uid);
                    initGame();
                } else {
                    currentUser = null;
                    dom.login_container.classList.remove('hidden');
                    dom.game_container.classList.add('hidden');
                    if (unsubscribeLeaderboard) unsubscribeLeaderboard();
                }
            });
        }
        
        async function handleAuth(action) {
            if (!auth) { dom.auth_error.textContent = "서버 연결이 필요합니다."; return; }
            const email = dom.email_input.value;
            const password = dom.password_input.value;
            dom.auth_error.textContent = '';
            try {
                if (action === 'login') {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await saveGameData(userCredential.user.uid, true);
                }
            } catch (error) {
                dom.auth_error.textContent = "이메일 또는 비밀번호를 확인하세요.";
            }
        }
        dom.login_btn.addEventListener('click', () => handleAuth('login'));
        dom.signup_btn.addEventListener('click', () => handleAuth('signup'));
        dom.guest_login_btn.addEventListener('click', () => {
             currentUser = { uid: 'guest', isAnonymous: true, email: '게스트' };
             dom.user_email.textContent = '게스트';
             dom.login_container.classList.add('hidden');
             dom.game_container.classList.remove('hidden');
             loadGameData('guest');
             initGame();
        });
        dom.logout_btn.addEventListener('click', () => {
            if (currentUser && !currentUser.isAnonymous) { signOut(auth); }
            else { currentUser = null; dom.login_container.classList.remove('hidden'); dom.game_container.classList.add('hidden'); }
        });

        async function loadGameData(userId) {
            if (userId === 'guest') {
                const savedData = localStorage.getItem('treats-tycoon-guest-save');
                gameState = savedData ? JSON.parse(savedData) : getBaseGameState();
                return;
            }
            if (!db) { gameState = getBaseGameState(); return; }
            const userDocRef = doc(db, 'players', userId);
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
                gameState = docSnap.data();
            } else {
                gameState = getBaseGameState();
                gameState.email = currentUser.email;
            }
        }

        async function saveGameData(userId, isNewUser = false) {
            if (!userId) return;
            if (userId === 'guest') {
                localStorage.setItem('treats-tycoon-guest-save', JSON.stringify(gameState));
                return;
            }
            if (!db) return;
            const userDocRef = doc(db, 'players', userId);
            
            let dataToSave = gameState;
            if(isNewUser) {
                dataToSave = getBaseGameState();
                dataToSave.email = currentUser.email;
            }
            
            await setDoc(userDocRef, { ...dataToSave, uid: userId }, { merge: true });
        }
        
        function listenToLeaderboard() {
            if (!db || (currentUser && currentUser.isAnonymous)) {
                dom.leaderboard.innerHTML = '<p class="text-center text-gray-400 p-4">리더보드는<br>이메일로 로그인 후<br>이용 가능합니다.</p>';
                return;
            }
            
            const q = query(collection(db, "players"), orderBy("totalSales", "desc"), limit(10));

            unsubscribeLeaderboard = onSnapshot(q, (snapshot) => {
                const leaderboardHtml = snapshot.docs.map((doc, index) => {
                    const data = doc.data();
                    const isCurrentUser = data.uid === currentUser?.uid;
                    return `<div class="flex justify-between items-center p-2 rounded ${isCurrentUser ? 'bg-indigo-500' : ''}"><div class="flex items-center"><span class="font-bold w-6">${index + 1}.</span><span class="truncate">${data.email || '익명'}</span></div><span class="font-bold text-green-400">$${Math.round(data.totalSales || 0)}</span></div>`;
                }).join('');
                dom.leaderboard.innerHTML = leaderboardHtml || '<p class="text-center text-gray-400">아직 순위가 없습니다.</p>';
            }, (error) => {
                console.error("리더보드 로딩 실패:", error);
                dom.leaderboard.innerHTML = '<p class="text-center text-red-400">리더보드를 불러오는 데 실패했습니다. 데이터베이스 규칙을 확인하세요.</p>';
            });
        }
        
        function initGame() {
            dom.flavor_options.innerHTML = FLAVORS.map(f => `<div class="flex items-center bg-gray-700 p-2 rounded"><input type="checkbox" id="flavor-${f.name}" value="${f.name}" class="form-checkbox h-4 w-4 text-indigo-600 bg-gray-800 border-gray-600 rounded focus:ring-indigo-500"><label for="flavor-${f.name}" class="ml-2 text-white text-xs">${f.name}</label></div>`).join('');
            dom.upgrades_container.innerHTML = Object.keys(getBaseGameState().upgrades).map(key => { const upg = getBaseGameState().upgrades[key]; return `<div class="bg-gray-900 p-4 rounded-lg"><div class="flex justify-between items-center mb-2"><h4 class="font-bold">${upg.name} (Lv.<span id="upgrade-${key}-level">0</span>)</h4><p id="upgrade-${key}-desc" class="text-sm text-gray-400"></p></div><button id="upgrade-${key}-btn" data-key="${key}" class="w-full bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg btn">업그레이드: $<span id="upgrade-${key}-cost">${upg.cost}</span></button></div>`; }).join('');
            ['vg_slider', 'nicotine_slider', 'flavor_strength_slider', 'cooling_slider', 'price_slider'].forEach(key => dom[key].addEventListener('input', updateRecipeSummary));
            dom.create_batch_btn.addEventListener('click', createAndSellBatch);
            dom.flavor_options.addEventListener('change', e => { if (e.target.type === 'checkbox' && getSelectedFlavors().length > 3) e.target.checked = false; });
            dom.upgrades_container.addEventListener('click', e => { if (e.target.closest('button')?.dataset.key) buyUpgrade(e.target.closest('button').dataset.key); });
            updateAllUI();
            listenToLeaderboard();
        }

        function updateAllUI() {
            dom.cash.textContent = `$${Math.round(gameState.cash)}`;
            dom.total_sales.textContent = `$${Math.round(gameState.totalSales)}`;
            dom.best_recipe_name.textContent = gameState.bestRecipe.name;
            const newLevel = Math.floor(Math.log2(gameState.totalSales / 1000 + 1)) + 1;
            if(newLevel > gameState.companyLevel) { gameState.companyLevel = newLevel; logMessage(`🎉 축하합니다! 회사 레벨이 ${gameState.companyLevel}이 되었습니다!`, 'trend'); }
            dom.company_level.textContent = gameState.companyLevel;
            const canAffordBatch = gameState.cash >= BATCH_COST;
            dom.create_batch_btn.disabled = !canAffordBatch;
            dom.create_batch_btn.classList.toggle('opacity-50', !canAffordBatch);
            updateUpgradesUI();
            updateRecipeSummary();
        }

        function updateUpgradesUI() {
            Object.keys(gameState.upgrades).forEach(key => {
                const upg = gameState.upgrades[key];
                const baseUpg = getBaseGameState().upgrades[key];
                document.getElementById(`upgrade-${key}-level`).textContent = upg.level;
                document.getElementById(`upgrade-${key}-desc`).textContent = `${baseUpg.name.split(" ")[1]} +${Math.round(upg.bonus*100)}%`;
                const costEl = document.getElementById(`upgrade-${key}-cost`);
                const btn = document.getElementById(`upgrade-${key}-btn`);
                if (upg.level >= upg.maxLevel) { btn.disabled = true; costEl.textContent = "MAX"; }
                else { costEl.textContent = upg.cost; btn.disabled = gameState.cash < upg.cost; }
                btn.classList.toggle('opacity-50', btn.disabled);
            });
            dom.market_trend.innerHTML = gameState.marketTrend.category ? `현재 트렌드: <span class="font-bold text-green-400">${gameState.marketTrend.category}</span> (${gameState.marketTrend.duration}턴 남음)` : '현재 트렌드: 없음';
        }
        
        function updateRecipeSummary() {
            const values = { vg: parseInt(dom.vg_slider.value), nicotine: parseInt(dom.nicotine_slider.value), flavorStrength: parseInt(dom.flavor_strength_slider.value), cooling: parseInt(dom.cooling_slider.value), price: parseInt(dom.price_slider.value) };
            values.pg = 100 - values.vg - values.flavorStrength;
            dom.vg_value.textContent = `${values.vg}%`; dom.nicotine_value.textContent = `${values.nicotine}mg`; dom.flavor_strength_value.textContent = `${values.flavorStrength}%`; dom.cooling_value.textContent = `${values.cooling}`; dom.price_value.textContent = `$${values.price}`;
            dom.summary_vg.textContent = `${values.vg}%`; dom.summary_flavor.textContent = `${values.flavorStrength}%`; dom.summary_nicotine.textContent = `${values.nicotine}mg`; dom.summary_cooling.textContent = `${values.cooling}`;
            if (values.pg < 0) { dom.summary_pg.textContent = 'Error!'; dom.summary_pg.classList.add('text-red-500'); dom.create_batch_btn.disabled = true;
            } else { dom.summary_pg.textContent = `${values.pg}%`; dom.summary_pg.classList.remove('text-red-500'); if(gameState.cash >= BATCH_COST) dom.create_batch_btn.disabled = false; }
        }

        async function createAndSellBatch() {
            const selectedFlavors = getSelectedFlavors();
            const recipeName = dom.recipe_name_input.value;
            const setPrice = parseInt(dom.price_slider.value);
            if (selectedFlavors.length === 0 || !recipeName.trim() || gameState.cash < BATCH_COST || (100 - parseInt(dom.vg_slider.value) - parseInt(dom.flavor_strength_slider.value)) < 0) { logMessage('❌ 제조 요건을 확인해주세요.', 'error'); return; }
            gameState.cash -= BATCH_COST; gameState.batchesMade++;

            const { qualityScore, penaltyMessage } = calculateRecipeQualityScore(selectedFlavors);
            
            if (penaltyMessage) {
                logMessage(`- 제조 실패 -<br>${penaltyMessage}`, 'error');
                updateAllUI();
                await saveGameData(currentUser.uid);
                return;
            }

            const { totalScore, nameScore, easterEggBonus, qualityText, isEasterEgg } = calculateTotalScore(recipeName, selectedFlavors, qualityScore);
            
            const optimalPrice = Math.round(15 + qualityScore * 15);
            const priceRatio = setPrice / optimalPrice;
            const salesVolume = Math.round((20 * qualityScore) / Math.pow(priceRatio, 1.5));
            
            let revenue = salesVolume * setPrice * (1 + gameState.upgrades.marketing.bonus);
            const recipeCategories = new Set(selectedFlavors.map(f => f.category));
            let trendBonusText = '';
            if(gameState.marketTrend.category && recipeCategories.has(gameState.marketTrend.category)) {
                revenue *= gameState.marketTrend.bonus;
                trendBonusText = ` <span class="text-green-300 font-bold">(트렌드 보너스! x${gameState.marketTrend.bonus})</span>`;
            }

            const profit = revenue - BATCH_COST;
            gameState.cash += revenue; gameState.totalSales += revenue;
            
            let priceFeedback = '';
            if (priceRatio > 1.2) priceFeedback = '가격이 너무 높았던 것 같습니다.';
            else if (priceRatio < 0.8) priceFeedback = '가격을 더 높여도 좋았을 것 같습니다.';

            const logHtml = `<div class="bg-gray-700 p-3 rounded-lg border-l-4 ${isEasterEgg ? 'border-yellow-400' : (profit > 0 ? 'border-green-500' : 'border-red-500')}">
                <p class="font-bold text-lg ${isEasterEgg ? 'text-yellow-300' : ''}">${recipeName}</p>
                <p class="text-sm ${isEasterEgg ? 'text-yellow-400' : 'text-yellow-300'} mb-1">${qualityText}${trendBonusText}</p>
                <p class="text-xs text-gray-400">판매: ${salesVolume}개 (개당 $${setPrice}) / 품질: ${Math.round(qualityScore*100)} / 네이밍: ${Math.round(nameScore*100)}</p>
                <p class="text-sm mt-1">수익: <span class="${profit > 0 ? 'text-green-400' : 'text-red-400'} font-semibold">$${Math.round(profit)}</span> (총매출: $${Math.round(revenue)})</p>
                ${priceFeedback ? `<p class="text-xs italic text-gray-500 mt-1">${priceFeedback}</p>` : ''}
            </div>`;
            logMessage(logHtml, 'game');
            if (totalScore > gameState.bestRecipe.score) gameState.bestRecipe = { name: recipeName, score: totalScore };
            checkAndSetMarketTrend(); updateAllUI(); dom.recipe_name_input.value = '';
            await saveGameData(currentUser.uid);
        }

        function calculateTotalScore(recipeName, selectedFlavors, qualityScore) {
            const flavorNames = new Set(selectedFlavors.map(f => f.name)); let isEasterEgg = false, easterEggBonus = 1.0, qualityText = '';
            const lowerName = recipeName.toLowerCase();
            if (lowerName.includes('소시오피치') && flavorNames.has('복숭아') && flavorNames.has('자두')) { isEasterEgg = true; easterEggBonus = 1.8; qualityText = "🎉 히든 레시피 발견! [소시오피치]"; }
            else if (lowerName.includes('고트애플') && flavorNames.has('사과') && flavorNames.has('딸기')) { isEasterEgg = true; easterEggBonus = 1.8; qualityText = "🎉 히든 레시피 발견! [고트애플]"; }
            const nameScore = calculateNameScore(recipeName, selectedFlavors);
            const totalScore = qualityScore * nameScore * easterEggBonus;
            if (!isEasterEgg) {
                if (totalScore > 1.0) qualityText = "👑 대히트 예감!"; else if (totalScore > 0.8) qualityText = "👍 아주 좋은데요?"; else if (totalScore > 0.6) qualityText = "🤔 나쁘지 않아요."; else qualityText = "😥 개선이 필요해 보입니다...";
            } return { totalScore, nameScore, easterEggBonus, qualityText, isEasterEgg };
        }

        function calculateRecipeQualityScore(selectedFlavors) {
            const values = { nicotine: parseInt(dom.nicotine_slider.value), flavorStrength: parseInt(dom.flavor_strength_slider.value), cooling: parseInt(dom.cooling_slider.value) };
            if (values.flavorStrength > 25) return { qualityScore: 0, penaltyMessage: "향료가 너무 강해 아무도 찾지 않습니다." };
            if (values.nicotine > 15) return { qualityScore: 0, penaltyMessage: "니코틴이 너무 강력해 아무도 찾지 않습니다." };
            if (values.cooling > 8) return { qualityScore: 0, penaltyMessage: "쿨링이 너무 강력해 아무도 찾지 않습니다." };
            
            const categories = selectedFlavors.map(f => f.category); let flavorComboScore = 0.5;
            if (categories.length === 1) flavorComboScore = 1.0;
            else if (categories.length > 1) { const comboKey = [...new Set(categories)].sort().join('-'); const reverseKey = [...new Set(categories)].sort().reverse().join('-'); flavorComboScore = COMBO_SCORES[comboKey] || COMBO_SCORES[reverseKey] || 0.4; }
            if (categories.length === 3 && new Set(categories).size === 3) flavorComboScore = 0.3;
            flavorComboScore *= (1 + gameState.upgrades.flavor_rnd.bonus);
            values.vg = parseInt(dom.vg_slider.value);
            const scores = { vg: Math.max(0, 1 - Math.abs(values.vg - 60) / 40), flavorStrength: Math.max(0, 1 - Math.abs(values.flavorStrength - 15) / 15), nicotine: Math.max(0, 1 - Math.abs(values.nicotine - 4.5) / 10), cooling: Math.max(0.3, 1 - Math.abs(values.cooling - 4) / 6) };
            const finalScore = (flavorComboScore * 0.40) + (scores.vg * 0.20) + (scores.flavorStrength * 0.15) + (scores.nicotine * 0.10) + (scores.cooling * 0.15);
            return { qualityScore: Math.max(0.1, finalScore * (1 + gameState.upgrades.lab.bonus)), penaltyMessage: null };
        }

        function calculateNameScore(name, selectedFlavors) {
            if (!name.trim()) return 0.8; let score = 1.0; let containedFlavors = 0;
            selectedFlavors.forEach(f => { if (name.toLowerCase().includes(f.name)) containedFlavors++; });
            if (containedFlavors === selectedFlavors.length && selectedFlavors.length > 0) score += 0.25;
            else if (containedFlavors > 0) score += 0.1 * containedFlavors;
            if (name.length > 5 && name.length < 20) score += 0.05;
            if (selectedFlavors.length === 1 && name.toLowerCase() === selectedFlavors[0].name) score -= 0.1;
            return Math.min(1.4, Math.max(0.8, score));
        }
        function buyUpgrade(key) {
            const upg = gameState.upgrades[key];
            if (gameState.cash >= upg.cost && upg.level < upg.maxLevel) {
                gameState.cash -= upg.cost; upg.level++; upg.bonus += upg.bonusPerLevel;
                upg.cost = Math.round(upg.baseCost * Math.pow(1.8, upg.level));
                logMessage(`✅ ${upg.name}을(를) Lv.${upg.level}(으)로 업그레이드했습니다!`, 'system');
                updateAllUI(); saveGameData(currentUser.uid);
            }
        }
        function checkAndSetMarketTrend() {
            if (gameState.marketTrend.duration > 0) { gameState.marketTrend.duration--;
                if (gameState.marketTrend.duration === 0) { gameState.marketTrend.category = null; logMessage('🔔 시장 트렌드가 초기화되었습니다.', 'system'); }
            } else if (gameState.batchesMade > 0 && gameState.batchesMade % 5 === 0) {
                const trendCategories = ['과일', '디저트', '멘솔', '음료'];
                gameState.marketTrend.category = trendCategories[Math.floor(Math.random() * trendCategories.length)];
                gameState.marketTrend.duration = 5;
                logMessage(`🔔 시장 뉴스: 지금은 '${gameState.marketTrend.category}' 계열이 대유행! (x${gameState.marketTrend.bonus} 보너스)`, 'trend');
            }
        }
        function getSelectedFlavors() { const selected = []; dom.flavor_options.querySelectorAll('input:checked').forEach(cb => { const flavor = FLAVORS.find(f => f.name === cb.value); if(flavor) selected.push(flavor); }); return selected; }
        function logMessage(message, type = 'info') {
            if (dom.log.firstElementChild?.textContent.includes('표시됩니다')) dom.log.innerHTML = '';
            const div = document.createElement('div');
            const typeClasses = { game: '', error: 'text-red-400 font-bold p-2 text-center', system: 'text-blue-300 italic p-2 text-center', trend: 'text-yellow-300 font-bold p-2 text-center bg-yellow-900/50 rounded-lg' };
            if (type === 'game') div.innerHTML = message;
            else { div.textContent = message; div.className = typeClasses[type] || 'text-gray-400'; }
            dom.log.prepend(div);
        }
    </script>
</body>
</html>
