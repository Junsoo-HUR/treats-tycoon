<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TREATS íƒ€ì´ì¿¤ - ì•¡ìƒ íšŒì‚¬ë¥¼ ê²½ì˜í•˜ì„¸ìš”!</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Noto Sans KR', sans-serif; background-color: #111827; }
        .slider-thumb::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: #4f46e5; cursor: pointer; border-radius: 50%; }
        .slider-thumb::-moz-range-thumb { width: 20px; height: 20px; background: #4f46e5; cursor: pointer; border-radius: 50%; }
        .flavor-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
        .btn { transition: all 0.2s ease-in-out; }
        .btn:disabled { background-color: #374151; cursor: not-allowed; opacity: 0.6; }
        .btn:not(:disabled):hover { filter: brightness(1.2); }
    </style>
</head>
<body class="text-white">

    <!-- ë¡œê·¸ì¸ ì»¨í…Œì´ë„ˆ -->
    <div id="login-container" class="flex items-center justify-center min-h-screen">
        <div class="w-full max-w-md bg-gray-800 p-8 rounded-xl shadow-lg">
            <h1 class="text-3xl font-bold text-center text-indigo-400 mb-2">TREATS íƒ€ì´ì¿¤</h1>
            <p class="text-center text-gray-400 mb-6">ë¡œê·¸ì¸í•˜ì—¬ íšŒì‚¬ë¥¼ ê²½ì˜í•˜ì„¸ìš”</p>
            <div class="space-y-4">
                <input type="email" id="email-input" placeholder="ì´ë©”ì¼" class="w-full bg-gray-700 text-white p-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <input type="password" id="password-input" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full bg-gray-700 text-white p-3 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
            </div>
            <div id="auth-error" class="text-red-400 text-sm mt-4 h-5 text-center"></div>
            <div class="grid grid-cols-2 gap-4 mt-4">
                <button id="login-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg btn">ë¡œê·¸ì¸</button>
                <button id="signup-btn" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg btn">íšŒì›ê°€ì…</button>
            </div>
            <div class="mt-4">
                 <button id="guest-login-btn" class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-lg btn">ê²ŒìŠ¤íŠ¸ë¡œ í”Œë ˆì´í•˜ê¸°</button>
            </div>
        </div>
    </div>
    
    <!-- ë©”ì¸ ê²Œì„ ì»¨í…Œì´ë„ˆ -->
    <div id="game-container" class="container mx-auto p-4 md:p-6 max-w-7xl hidden">
        <header class="text-center mb-6 relative">
            <div id="user-info-container" class="absolute top-0 right-0 text-right">
                <p id="user-email" class="text-gray-300"></p>
                <button id="logout-btn" class="text-sm text-indigo-400 hover:underline">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
            <h1 class="text-4xl md:text-5xl font-bold text-indigo-400">TREATS íƒ€ì´ì¿¤ ğŸ¢</h1>
            <p class="text-gray-400 mt-2">ìµœê³ ì˜ ì•¡ìƒì„ ë§Œë“¤ê³ , íšŒì‚¬ë¥¼ ì„±ì¥ì‹œì¼œ ì—…ê³„ì˜ ì „ì„¤ì´ ë˜ì„¸ìš”!</p>
        </header>

        <div class="bg-gray-800 p-4 rounded-xl shadow-lg mb-6 grid grid-cols-2 md:grid-cols-4 gap-4 text-center">
            <div><h2 class="text-sm font-bold text-gray-400">ğŸ’° ìë³¸ê¸ˆ</h2><p id="cash" class="text-2xl font-bold text-green-400">$1,000</p></div>
            <div><h2 class="text-sm font-bold text-gray-400">ğŸ“ˆ ì´ë§¤ì¶œ (ì ìˆ˜)</h2><p id="total-sales" class="text-2xl font-bold text-blue-400">$0</p></div>
            <div><h2 class="text-sm font-bold text-gray-400">ğŸ­ íšŒì‚¬ ë ˆë²¨</h2><p id="company-level" class="text-2xl font-bold text-purple-400">1</p></div>
            <div><h2 class="text-sm font-bold text-gray-400">â­ ìµœê³  í‰ì  ë ˆì‹œí”¼</h2><p id="best-recipe-name" class="text-lg font-bold text-yellow-400">-</p></div>
        </div>

        <main class="grid lg:grid-cols-3 gap-6">
            <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">ğŸ‘¨â€ğŸ”¬ ì•¡ìƒ ì œì¡°ê¸°</h2>
                <div class="mb-2">
                    <h3 class="font-bold mb-2 text-sm">1. í–¥ë£Œ ì„ íƒ (ìµœëŒ€ 3ê°œ)</h3>
                    <div id="flavor-options" class="grid flavor-grid gap-2 text-sm max-h-32 overflow-y-auto pr-2"></div>
                </div>
                <div class="mb-2">
                    <h3 class="font-bold mb-3 text-sm">2. ë¹„ìœ¨ ì¡°ì ˆ</h3>
                    <div class="space-y-2">
                        <div><label for="vg-slider" class="flex justify-between text-xs"><span>VG</span><span id="vg-value" class="font-bold text-indigo-300">50%</span></label><input id="vg-slider" type="range" min="0" max="100" value="50" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb"></div>
                        <div><label for="flavor-strength-slider" class="flex justify-between text-xs"><span>í–¥ë£Œ ë†ë„</span><span id="flavor-strength-value" class="font-bold text-indigo-300">10%</span></label><input id="flavor-strength-slider" type="range" min="1" max="30" value="10" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb"></div>
                        <div><label for="nicotine-slider" class="flex justify-between text-xs"><span>ë‹ˆì½”í‹´</span><span id="nicotine-value" class="font-bold text-indigo-300">3mg</span></label><input id="nicotine-slider" type="range" min="0" max="20" value="3" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb"></div>
                        <div><label for="cooling-slider" class="flex justify-between text-xs"><span>ì¿¨ë§ ê°•ë„</span><span id="cooling-value" class="font-bold text-indigo-300">0</span></label><input id="cooling-slider" type="range" min="0" max="10" value="0" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb"></div>
                    </div>
                </div>
                <div class="mb-2">
                    <h3 class="font-bold mb-2 text-sm">3. ì´ë¦„ ì§“ê¸°</h3>
                    <input type="text" id="recipe-name-input" placeholder="ì•¡ìƒ ì´ë¦„ì„ ì§€ì–´ì£¼ì„¸ìš”..." class="w-full bg-gray-700 text-white p-2 rounded-md border border-gray-600 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mb-4">
                    <h3 class="font-bold mb-2 text-sm">4. ê°€ê²© ì±…ì • ($10 ~ $30)</h3>
                    <label for="price-slider" class="flex justify-between text-xs"><span>íŒë§¤ ê°€ê²©</span><span id="price-value" class="font-bold text-green-400">$20</span></label>
                    <input id="price-slider" type="range" min="10" max="30" value="20" class="w-full h-2 bg-gray-700 rounded-lg appearance-none cursor-pointer slider-thumb">
                </div>
                 <div class="bg-gray-900 p-3 rounded-lg mb-4">
                     <h3 class="font-bold mb-2 text-center text-md">ğŸ§ª ë ˆì‹œí”¼ ìš”ì•½</h3>
                     <div class="grid grid-cols-5 gap-1 text-center text-xs">
                        <div><p class="text-gray-400">VG</p><p id="summary-vg" class="font-semibold">50%</p></div>
                        <div><p class="text-gray-400">PG</p><p id="summary-pg" class="font-semibold">40%</p></div>
                        <div><p class="text-gray-400">í–¥ë£Œ</p><p id="summary-flavor" class="font-semibold">10%</p></div>
                        <div><p class="text-gray-400">ë‹ˆì½”í‹´</p><p id="summary-nicotine" class="font-semibold">3mg</p></div>
                        <div><p class="text-gray-400">ì¿¨ë§</p><p id="summary-cooling" class="font-semibold">0</p></div>
                     </div>
                </div>
                <button id="create-batch-btn" class="w-full bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg shadow-lg btn">ì œì¡° ë° íŒë§¤ (ë¹„ìš©: $50)</button>
            </div>

            <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg">
                <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">ğŸ“¢ íŒë§¤ ê²°ê³¼ ë¡œê·¸</h2>
                <div id="log" class="h-[46rem] overflow-y-auto space-y-3 pr-2">
                    <div class="text-gray-400">ì•¡ìƒì„ ì œì¡°í•˜ë©´ ì—¬ê¸°ì— íŒë§¤ ê²°ê³¼ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
                </div>
            </div>
            
            <div class="lg:col-span-1 bg-gray-800 p-6 rounded-xl shadow-lg flex flex-col">
                 <h2 class="text-2xl font-bold mb-4 border-b border-gray-700 pb-2">ğŸ¢ íšŒì‚¬ ê´€ë¦¬</h2>
                 <div class="mb-4 bg-gray-900 p-4 rounded-lg text-center">
                     <h3 class="font-bold text-indigo-300">ğŸ“ˆ ì‹œì¥ íŠ¸ë Œë“œ</h3>
                     <p id="market-trend" class="text-lg">ë¶„ì„ ì¤‘...</p>
                 </div>
                 <h3 class="font-bold text-lg mb-3">ğŸ› ï¸ íšŒì‚¬ ì—…ê·¸ë ˆì´ë“œ</h3>
                 <div id="upgrades-container" class="space-y-3 mb-4"></div>
                 
                 <div class="flex-grow flex flex-col min-h-0">
                    <h3 class="font-bold text-lg mb-3 text-yellow-300">ğŸ† ë¦¬ë”ë³´ë“œ</h3>
                    <div id="leaderboard" class="bg-gray-900 p-4 rounded-lg flex-grow overflow-y-auto">
                        <div class="text-center text-gray-400">ë¦¬ë”ë³´ë“œ ë¡œë”© ì¤‘...</div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, orderBy, limit, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase ì„¤ì • ---
        const firebaseConfig = {
          apiKey: "AIzaSyCjDwX6xPw3SUee1v1uV82I5knKSC3LFkY",
          authDomain: "treats-ty.firebaseapp.com",
          projectId: "treats-ty",
          storageBucket: "treats-ty.firebasestorage.app",
          messagingSenderId: "237687562163",
          appId: "1:237687562163:web:07fa35e6fd8b28950735c6",
          measurementId: "G-R001G0DS6W"
        };

        let db, auth;
        try {
            if (!firebaseConfig.apiKey) {
                throw new Error("Firebase ì„¤ì •ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.");
            }
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
        } catch (e) {
            console.error(e.message);
            document.addEventListener('DOMContentLoaded', () => {
                const loginContainer = document.getElementById('login-container');
                if (loginContainer) {
                    document.getElementById('login-btn').disabled = true;
                    document.getElementById('signup-btn').disabled = true;
                    const authError = document.getElementById('auth-error');
                    if(authError) authError.textContent = "ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ê²ŒìŠ¤íŠ¸ë¡œë§Œ í”Œë ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.";
                }
            });
        }

        const dom = {};
        ['login-container', 'game-container', 'email-input', 'password-input', 'login-btn', 'signup-btn', 'guest-login-btn', 'logout-btn', 'auth-error', 'user-email', 'cash', 'total-sales', 'company-level', 'best-recipe-name', 'flavor-options', 'log', 'vg-slider', 'nicotine-slider', 'flavor-strength-slider', 'cooling-slider', 'price-slider', 'vg-value', 'nicotine-value', 'flavor-strength-value', 'cooling-value', 'price-value', 'summary-vg', 'summary-pg', 'summary-flavor', 'summary-nicotine', 'summary-cooling', 'recipe-name-input', 'create-batch-btn', 'market-trend', 'upgrades-container', 'leaderboard'].forEach(id => dom[id.replace(/-/g, '_')] = document.getElementById(id));
        
        const BATCH_COST = 50;
        const FLAVORS = [ { name: 'ë”¸ê¸°', category: 'ê³¼ì¼' }, { name: 'ë°”ë‚˜ë‚˜', category: 'ê³¼ì¼' }, { name: 'ë¸”ë£¨ë² ë¦¬', category: 'ê³¼ì¼' }, { name: 'ë§ê³ ', category: 'ê³¼ì¼' }, { name: 'ë ˆëª¬', category: 'ê³¼ì¼' }, { name: 'ë¼ì„', category: 'ê³¼ì¼' }, { name: 'ì‚¬ê³¼', category: 'ê³¼ì¼' }, { name: 'ë³µìˆ­ì•„', category: 'ê³¼ì¼' }, { name: 'ìë‘', category: 'ê³¼ì¼' }, { name: 'íŒŒì¸ì• í”Œ', category: 'ê³¼ì¼' }, { name: 'í¬ë„', category: 'ê³¼ì¼' }, { name: 'ìëª½', category: 'ê³¼ì¼' }, { name: 'ìˆ˜ë°•', category: 'ê³¼ì¼' }, { name: 'ë©œë¡ ', category: 'ê³¼ì¼' }, { name: 'ë¦¬ì¹˜', category: 'ê³¼ì¼' }, { name: 'ì²´ë¦¬', category: 'ê³¼ì¼' }, { name: 'íŒ¨ì…˜í›„ë¥´ì¸ ', category: 'ê³¼ì¼' }, { name: 'ë°”ë‹ë¼', category: 'ë””ì €íŠ¸' }, { name: 'ì»¤ìŠ¤íƒ€ë“œ', category: 'ë””ì €íŠ¸' }, { name: 'ì¹˜ì¦ˆì¼€ì´í¬', category: 'ë””ì €íŠ¸' }, { name: 'ì´ˆì½œë¦¿', category: 'ë””ì €íŠ¸' }, { name: 'ì¹´ë¼ë©œ', category: 'ë””ì €íŠ¸' }, { name: 'ì• í”ŒíŒŒì´', category: 'ë””ì €íŠ¸' }, { name: 'ë„ë„›', category: 'ë””ì €íŠ¸' }, { name: 'ë¸Œë¼ìš°ë‹ˆ', category: 'ë””ì €íŠ¸' }, { name: 'ì¿ í‚¤ì•¤í¬ë¦¼', category: 'ë””ì €íŠ¸' }, { name: 'ìŠˆí¬ë¦¼', category: 'ë””ì €íŠ¸' }, { name: 'í”¼ë„›ë²„í„°', category: 'ë””ì €íŠ¸' }, { name: 'í¬ë¦¼ë¸Œë¥„ë ˆ', category: 'ë””ì €íŠ¸' }, { name: 'ì—°ì´ˆ', category: 'ì—°ì´ˆ' }, { name: 'ì‹œê°€', category: 'ì—°ì´ˆ' }, { name: 'ë²„ì§€ë‹ˆì•„', category: 'ì—°ì´ˆ' }, { name: 'í„°í‚¤ì‰¬', category: 'ì—°ì´ˆ' }, { name: 'ë©˜ì†”', category: 'ë©˜ì†”' }, { name: 'ìŠ¤í”¼ì–´ë¯¼íŠ¸', category: 'ë©˜ì†”' }, { name: 'ì¿¨ë¯¼íŠ¸', category: 'ë©˜ì†”' }, { name: 'ì»¤í”¼', category: 'ìŒë£Œ' }, { name: 'ì½œë¼', category: 'ìŒë£Œ' }, { name: 'ì—ë„ˆì§€ë“œë§í¬', category: 'ìŒë£Œ' }, { name: 'ë…¹ì°¨', category: 'ìŒë£Œ' }, { name: 'ë°€í¬í‹°', category: 'ìŒë£Œ' }, { name: 'ëª¨íˆí† ', category: 'ìŒë£Œ' }, { name: 'ê¿€', category: 'ê¸°íƒ€' }, { name: 'ì‹œë‚˜ëª¬', category: 'ê¸°íƒ€' }, { name: 'ì¥ë¯¸', category: 'ê¸°íƒ€' }, { name: 'íŒì½˜', category: 'ê¸°íƒ€' }, ];
        const COMBO_SCORES = {'ê³¼ì¼-ê³¼ì¼': 1.0, 'ê³¼ì¼-ë””ì €íŠ¸': 0.95, 'ê³¼ì¼-ë©˜ì†”': 0.9, 'ê³¼ì¼-ìŒë£Œ': 0.8, 'ë””ì €íŠ¸-ë””ì €íŠ¸': 0.8, 'ë””ì €íŠ¸-ë©˜ì†”': 0.6, 'ë””ì €íŠ¸-ì—°ì´ˆ': 0.9, 'ë””ì €íŠ¸-ìŒë£Œ': 0.85, 'ì—°ì´ˆ-ì—°ì´ˆ': 1.0, 'ì—°ì´ˆ-ë©˜ì†”': 0.7, 'ì—°ì´ˆ-ê¸°íƒ€': 0.8, 'ë©˜ì†”-ìŒë£Œ': 0.85, 'ê¸°íƒ€-ë””ì €íŠ¸': 0.9, 'ê¸°íƒ€-ê³¼ì¼': 0.7};
        
        let gameState = {};
        let currentUser = null;
        let unsubscribeLeaderboard = null;

        function getBaseGameState() {
            return {
                email: '', cash: 1000, totalSales: 0, companyLevel: 1, batchesMade: 0,
                bestRecipe: { name: '-', score: 0 },
                upgrades: {
                    lab: { level: 0, cost: 250, baseCost: 250, bonus: 0, bonusPerLevel: 0.01, maxLevel: 10, name: "ğŸ”¬ ì—°êµ¬ì‹¤ í™•ì¥" },
                    marketing: { level: 0, cost: 400, baseCost: 400, bonus: 0, bonusPerLevel: 0.05, maxLevel: 15, name: "ğŸ“¢ ë§ˆì¼€íŒ…" },
                    flavor_rnd: { level: 0, cost: 1000, baseCost: 1000, bonus: 0, bonusPerLevel: 0.02, maxLevel: 5, name: "âš—ï¸ í–¥ë£Œ R&D" }
                },
                marketTrend: { category: null, duration: 0, bonus: 1.5 }
            };
        }
        
        if (auth) {
            onAuthStateChanged(auth, async user => {
                if (user) {
                    currentUser = user;
                    dom.user_email.textContent = user.isAnonymous ? 'ê²ŒìŠ¤íŠ¸' : user.email;
                    dom.login_container.classList.add('hidden');
                    dom.game_container.classList.remove('hidden');
                    await loadGameData(user.uid);
                    initGame();
                } else {
                    currentUser = null;
                    dom.login_container.classList.remove('hidden');
                    dom.game_container.classList.add('hidden');
                    if (unsubscribeLeaderboard) unsubscribeLeaderboard();
                }
            });
        }
        
        async function handleAuth(action) {
            if (!auth) { dom.auth_error.textContent = "ì„œë²„ ì—°ê²°ì´ í•„ìš”í•©ë‹ˆë‹¤."; return; }
            const email = dom.email_input.value;
            const password = dom.password_input.value;
            dom.auth_error.textContent = '';
            try {
                if (action === 'login') {
                    await signInWithEmailAndPassword(auth, email, password);
                } else {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, password);
                    await saveGameData(userCredential.user.uid, true);
                }
            } catch (error) {
                console.error("Authentication Error:", error);
                let errorMessage = "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                switch (error.code) {
                    case 'auth/invalid-email':
                        errorMessage = 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.';
                        break;
                    case 'auth/user-not-found':
                    case 'auth/wrong-password':
                        errorMessage = 'ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ í‹€ë ¸ìŠµë‹ˆë‹¤.';
                        break;
                    case 'auth/email-already-in-use':
                        errorMessage = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ì…ë‹ˆë‹¤.';
                        break;
                    case 'auth/weak-password':
                        errorMessage = 'ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.';
                        break;
                    default:
                        errorMessage = `ì˜¤ë¥˜: ${error.code}`;
                        break;
                }
                dom.auth_error.textContent = errorMessage;
            }
        }
        dom.login_btn.addEventListener('click', () => handleAuth('login'));
        dom.signup_btn.addEventListener('click', () => handleAuth('signup'));
        dom.guest_login_btn.addEventListener('click', () => {
             currentUser = { uid: 'guest', isAnonymous: true, email: 'ê²ŒìŠ¤íŠ¸' };
             dom.user_email.textContent = 'ê²ŒìŠ¤íŠ¸';
             dom.login_container.classList.add('hidden');
             dom.game_container.classList.remove('hidden');
             loadGameData('guest');
             initGame();
        });
        dom.logout_btn.addEventListener('click', () => {
            if (currentUser && !currentUser.isAnonymous) { signOut(auth); }
            else { currentUser = null; dom.login_container.classList.remove('hidden'); dom.game_container.classList.add('hidden'); }
        });

        async function loadGameData(userId) {
            if (userId === 'guest') {
                const savedData = localStorage.getItem('treats-tycoon-guest-save');
                gameState = savedData ? JSON.parse(savedData) : getBaseGameState();
                return;
            }
            if (!db) { gameState = getBaseGameState(); return; }
            const userDocRef = doc(db, 'players', userId);
            const docSnap = await getDoc(userDocRef);
            if (docSnap.exists()) {
                gameState = docSnap.data();
            } else {
                gameState = getBaseGameState();
                gameState.email = currentUser.email;
            }
        }

        async function saveGameData(userId, isNewUser = false) {
            if (!userId) return;
            if (userId === 'guest') {
                localStorage.setItem('treats-tycoon-guest-save', JSON.stringify(gameState));
                return;
            }
            if (!db) return;
            const userDocRef = doc(db, 'players', userId);
            
            let dataToSave = gameState;
            if(isNewUser) {
                dataToSave = getBaseGameState();
                dataToSave.email = currentUser.email;
            }
            
            await setDoc(userDocRef, { ...dataToSave, uid: userId }, { merge: true });
        }
        
        function listenToLeaderboard() {
            if (!db || (currentUser && currentUser.isAnonymous)) {
                dom.leaderboard.innerHTML = '<p class="text-center text-gray-400 p-4">ë¦¬ë”ë³´ë“œëŠ”<br>ì´ë©”ì¼ë¡œ ë¡œê·¸ì¸ í›„<br>ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>';
                return;
            }
            
            const q = query(collection(db, "players"), orderBy("totalSales", "desc"), limit(10));

            unsubscribeLeaderboard = onSnapshot(q, (snapshot) => {
                const leaderboardHtml = snapshot.docs.map((doc, index) => {
                    const data = doc.data();
                    const isCurrentUser = data.uid === currentUser?.uid;
                    return `<div class="flex justify-between items-center p-2 rounded ${isCurrentUser ? 'bg-indigo-500' : ''}"><div class="flex items-center"><span class="font-bold w-6">${index + 1}.</span><span class="truncate">${data.email || 'ìµëª…'}</span></div><span class="font-bold text-green-400">$${Math.round(data.totalSales || 0)}</span></div>`;
                }).join('');
                dom.leaderboard.innerHTML = leaderboardHtml || '<p class="text-center text-gray-400">ì•„ì§ ìˆœìœ„ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            }, (error) => {
                console.error("ë¦¬ë”ë³´ë“œ ë¡œë”© ì‹¤íŒ¨:", error);
                dom.leaderboard.innerHTML = '<p class="text-center text-red-400">ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ ê·œì¹™ì„ í™•ì¸í•˜ì„¸ìš”.</p>';
            });
        }
        
        function initGame() {
            dom.flavor_options.innerHTML = FLAVORS.map(f => `<div class="flex items-center bg-gray-700 p-2 rounded"><input type="checkbox" id="flavor-${f.name}" value="${f.name}" class="form-checkbox h-4 w-4 text-indigo-600 bg-gray-800 border-gray-600 rounded focus:ring-indigo-500"><label for="flavor-${f.name}" class="ml-2 text-white text-xs">${f.name}</label></div>`).join('');
            dom.upgrades_container.innerHTML = Object.keys(getBaseGameState().upgrades).map(key => { const upg = getBaseGameState().upgrades[key]; return `<div class="bg-gray-900 p-4 rounded-lg"><div class="flex justify-between items-center mb-2"><h4 class="font-bold">${upg.name} (Lv.<span id="upgrade-${key}-level">0</span>)</h4><p id="upgrade-${key}-desc" class="text-sm text-gray-400"></p></div><button id="upgrade-${key}-btn" data-key="${key}" class="w-full bg-indigo-600 text-white font-bold py-2 px-3 rounded-lg btn">ì—…ê·¸ë ˆì´ë“œ: $<span id="upgrade-${key}-cost">${upg.cost}</span></button></div>`; }).join('');
            ['vg_slider', 'nicotine_slider', 'flavor_strength_slider', 'cooling_slider', 'price_slider'].forEach(key => dom[key].addEventListener('input', updateRecipeSummary));
            dom.create_batch_btn.addEventListener('click', createAndSellBatch);
            dom.flavor_options.addEventListener('change', e => { if (e.target.type === 'checkbox' && getSelectedFlavors().length > 3) e.target.checked = false; });
            dom.upgrades_container.addEventListener('click', e => { if (e.target.closest('button')?.dataset.key) buyUpgrade(e.targ
